# # This is a basic workflow to create secret in KV that is manually triggered

name: Set KV Secret 

on:
  workflow_dispatch:
    # Inputs the workflow accepts.
    inputs:
      kv_name:
        description: 'Name of the Vault'
        required: true
      secret_name:
        description: 'Name of the secret'
        required: true
      secret_value:
        description: 'Value of the secret'
        required: true

jobs:
  set-secret-kv:
    name: "Set Secret:"
    runs-on: ubuntu-latest
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_NONPROD }}
        
    - name: Create KV Secret
      uses: azure/CLI@v1
      env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS_NONPROD }}
      with:
        inlineScript: |
          SP_APPID=$(echo $AZURE_CREDENTIALS | jq -e -r 'select(.clientId != null) | .clientId')
          az keyvault set-policy -n ${{ github.event.inputs.kv_name }} --secret-permissions get list set --spn $SP_APPID
          SECRET_DETAIL=$(az keyvault secret set --name ${{ github.event.inputs.secret_name }} --vault-name ${{ github.event.inputs.kv_name }} --value ${{ github.event.inputs.secret_value }})
